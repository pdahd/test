name: é¢„å‘Šç‰‡ä¸‹è½½

on:
  workflow_dispatch:
    inputs:
      trailer_url:
        description: |
          ã€è¾“å…¥ Apple ç”µå½±é¢„å‘Šç‰‡é“¾æ¥ã€‘
          è¯·è®¿é—® Apple ç”µå½±å®˜ç½‘ï¼ˆhttps://tv.apple.com/ï¼‰ï¼Œé€‰æ‹©æˆ–æœç´¢å½±ç‰‡ï¼Œå¤åˆ¶æµè§ˆå™¨åœ°å€æ ä¸­çš„é“¾æ¥å¹¶ç²˜è´´åˆ°æ­¤å¤„ã€‚ä¸‹é¢æ˜¯æŸä¸ªé¢„å‘Šé“¾æ¥ç¤ºä¾‹ï¼š https://tv.apple.com/us/movie/spirited/umc.cmc.3lp7wqowerzdbej98tveildi3
        required: true
      resolution:
        description: |
          ã€é€‰æ‹©åˆ†è¾¨ç‡ã€‘
          è‹¥ Apple æœªæä¾› 4K åˆ†è¾¨ç‡ï¼Œå°†é»˜è®¤ä¸º 1080pï¼›è‹¥æä¾›çš„æœ€é«˜åˆ†è¾¨ç‡ä½äº 1080pï¼Œä¸‹è½½ä»»åŠ¡å°†è¢«å–æ¶ˆã€‚4K é¢„å‘Šç‰‡æä¾›æœæ¯”è§†ç•Œ (Dolby Vision) å’Œæœæ¯”å…¨æ™¯å£° (Dolby Atmos)ã€‚
        required: false
        type: choice
        options:
          - '1080p'
          - '4K'
      audio_language:
        description: |
          ã€é€‰æ‹©å£°éŸ³è¯­è¨€ã€‘
          æä¾› 10 ç§å£°éŸ³è¯­è¨€å¯ä¾›é€‰æ‹©ï¼›è‹¥ Apple æœªæä¾›æ‰€é€‰è¯­è¨€ï¼Œåˆ™é»˜è®¤ä¸ºè‹±è¯­ï¼ˆåŸå£°ï¼‰ã€‚
        required: false
        type: choice
        options:
          - 'ğŸ‡ºğŸ‡¸ è‹±è¯­ï¼ˆåŸå£°ï¼‰'
          - 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡æ™®é€šè¯'
          - 'ğŸ‡ªğŸ‡¸ åŠ æ³°ç½—å°¼äºšè¯­'
          - 'ğŸ‡©ğŸ‡ª å¾·è¯­'
          - 'ğŸ‡²ğŸ‡½ æ‹‰ä¸ç¾æ´²è¥¿ç­ç‰™è¯­'
          - 'ğŸ‡ªğŸ‡¸ æ¬§æ´²è¥¿ç­ç‰™è¯­'
          - 'ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§æ³•è¯­'
          - 'ğŸ‡«ğŸ‡· æ³•å›½æ³•è¯­'
          - 'ğŸ‡®ğŸ‡¹ æ„å¤§åˆ©è¯­'
          - 'ğŸ‡¯ğŸ‡µ æ—¥è¯­'
          - 'ğŸ‡§ğŸ‡· å·´è¥¿è‘¡è„ç‰™è¯­'
          - 'ğŸ‡·ğŸ‡º ä¿„è¯­'
          - 'ğŸ‡¹ğŸ‡­ æ³°è¯­'
          - 'ğŸ‡¹ğŸ‡· åœŸè€³å…¶è¯­'
          - 'ğŸ‡ºğŸ‡¦ ä¹Œå…‹å…°è¯­'
      subtitle_language:
        description: |
          ã€é€‰æ‹©å­—å¹•è¯­è¨€ã€‘
          æä¾› 41 ç§å­—å¹•è¯­è¨€ã€‚å­—å¹•é»˜è®¤å°è£…åœ¨è§†é¢‘ä¸­ï¼Œå¯åœ¨æ’­æ”¾æ—¶é€‰æ‹©å¼€å¯æˆ–å…³é—­ã€‚å®‰å“è®¾å¤‡å»ºè®®ä½¿ç”¨ MX Player å¹¶å¯ç”¨è½¯è§£ç æ’­æ”¾ã€‚è‹¥ Apple æœªæä¾›å­—å¹•ï¼Œåˆ™ä¸‹è½½çš„é¢„å‘Šç‰‡å°†ä¸åŒ…å«å­—å¹•ã€‚
        required: false
        type: choice
        options:
          - 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç®€ä½“'
          - 'ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ç¹é«”'
          - 'ğŸ‡­ğŸ‡° ä¸­æ–‡ç²¤è¯­'
          - 'ğŸ‡ºğŸ‡¸ è‹±è¯­ English'
          - 'ğŸ‡¸ğŸ‡¦ é˜¿æ‹‰ä¼¯è¯­ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'
          - 'ğŸ‡§ğŸ‡¬ ä¿åŠ åˆ©äºšè¯­ Ğ±ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸'
          - 'ğŸ‡¨ğŸ‡¿ æ·å…‹è¯­ ÄŒeÅ¡tina'
          - 'ğŸ‡©ğŸ‡° ä¸¹éº¦è¯­ dansk'
          - 'ğŸ‡©ğŸ‡ª å¾·è¯­ Deutsch'
          - 'ğŸ‡¬ğŸ‡· å¸Œè…Šè¯­ Î•Î»Î»Î·Î½Î¹ÎºÎ¬'
          - 'ğŸ‡²ğŸ‡½ è¥¿ç­ç‰™è¯­ï¼ˆæ‹‰ä¸ç¾æ´²ï¼‰ EspaÃ±ol (LatinoamÃ©rica)'
          - 'ğŸ‡ªğŸ‡¸ è¥¿ç­ç‰™è¯­ï¼ˆè¥¿ç­ç‰™ï¼‰ EspaÃ±ol (EspaÃ±a)'
          - 'ğŸ‡ªğŸ‡ª çˆ±æ²™å°¼äºšè¯­ eesti'
          - 'ğŸ‡«ğŸ‡® èŠ¬å…°è¯­ Suomi'
          - 'ğŸ‡¨ğŸ‡¦ æ³•è¯­ï¼ˆåŠ æ‹¿å¤§ï¼‰ FranÃ§ais (Canada)'
          - 'ğŸ‡«ğŸ‡· æ³•è¯­ï¼ˆæ³•å›½ï¼‰ FranÃ§ais (France)'
          - 'ğŸ‡®ğŸ‡± å¸Œä¼¯æ¥è¯­ ×¢×‘×¨×™×ª'
          - 'ğŸ‡®ğŸ‡³ å°åœ°è¯­ à¤¹à¤¿à¤¨à¥à¤¦à¥€'
          - 'ğŸ‡­ğŸ‡º åŒˆç‰™åˆ©è¯­ magyar'
          - 'ğŸ‡®ğŸ‡© å°å°¼è¯­ Bahasa Indonesia'
          - 'ğŸ‡®ğŸ‡¹ æ„å¤§åˆ©è¯­ Italiano'
          - 'ğŸ‡¯ğŸ‡µ æ—¥è¯­ æ—¥æœ¬èª'
          - 'ğŸ‡°ğŸ‡· éŸ©è¯­ í•œêµ­ì–´'
          - 'ğŸ‡±ğŸ‡¹ ç«‹é™¶å®›è¯­ lietuviÅ³'
          - 'ğŸ‡±ğŸ‡» æ‹‰è„±ç»´äºšè¯­ latvieÅ¡u'
          - 'ğŸ‡²ğŸ‡¾ é©¬æ¥è¯­ Bahasa Melayu'
          - 'ğŸ‡³ğŸ‡± è·å…°è¯­ Nederlands'
          - 'ğŸ‡³ğŸ‡´ æŒªå¨è¯­ norsk'
          - 'ğŸ‡µğŸ‡± æ³¢å…°è¯­ polski'
          - 'ğŸ‡§ğŸ‡· è‘¡è„ç‰™è¯­ï¼ˆå·´è¥¿ï¼‰ PortuguÃªs (Brasil)'
          - 'ğŸ‡µğŸ‡¹ è‘¡è„ç‰™è¯­ PortuguÃªs'
          - 'ğŸ‡·ğŸ‡º ä¿„è¯­ Ğ ÑƒÑÑĞºĞ¸Ğ¹'
          - 'ğŸ‡¸ğŸ‡° æ–¯æ´›ä¼å…‹è¯­ SlovenÄina'
          - 'ğŸ‡¸ğŸ‡® æ–¯æ´›æ–‡å°¼äºšè¯­ slovenÅ¡Äina'
          - 'ğŸ‡¸ğŸ‡ª ç‘å…¸è¯­ Svenska'
          - 'ğŸ‡®ğŸ‡³ æ³°ç±³å°”è¯­ à®¤à®®à®¿à®´à¯'
          - 'ğŸ‡®ğŸ‡³ æ³°å¢å›ºè¯­ à°¤à±†à°²à±à°—à±'
          - 'ğŸ‡¹ğŸ‡­ æ³°è¯­ à¹„à¸—à¸¢'
          - 'ğŸ‡¹ğŸ‡· åœŸè€³å…¶è¯­ TÃ¼rkÃ§e'
          - 'ğŸ‡ºğŸ‡¦ ä¹Œå…‹å…°è¯­ ÑƒĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°'
          - 'ğŸ‡»ğŸ‡³ è¶Šå—è¯­ Tiáº¿ng Viá»‡t'
      download_info: 
        description: |
          ğŸ“ƒä¸‹è½½è¯´æ˜ï¼š
        required: false 
        type: choice
        options:
          - 'ä¸‹è½½è¿‡ç¨‹ä¸­æœªç»ä»»ä½•é‡æ–°ç¼–ç æˆ–å‹ç¼©ï¼Œç›´æ¥ä» Apple æœåŠ¡å™¨æ‹·è´åŸå§‹æµæ•°æ®ï¼Œæ²¡æœ‰ä»»ä½•è´¨é‡æŸå¤±ã€‚ä¸‹è½½å®Œæˆåï¼Œæ‚¨å¯ä»¥åœ¨ GitHub Actions å·¥ä½œæµè¿è¡Œçš„â€œArtifactsâ€é€‰é¡¹å¡ä¸­æ‰¾åˆ°ä¸‹è½½çš„é¢„å‘Šç‰‡æ–‡ä»¶ã€‚'
        
      
jobs:
  download-apple-trailers:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download N_m3u8DL-CLI
      run: |
        Invoke-WebRequest -Uri https://github.com/nilaoda/N_m3u8DL-CLI/releases/download/3.0.2/N_m3u8DL-CLI_v3.0.2.exe -OutFile N_m3u8DL-CLI.exe
    
    - name: Download ffmpeg
      run: |
        Invoke-WebRequest -Uri https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip -OutFile ffmpeg-latest.zip
        Expand-Archive -Path ffmpeg-latest.zip -DestinationPath ffmpeg
        Move-Item ffmpeg/*/bin/ffmpeg.exe .
    
    - name: Process input URL
      run: |
        $trailerUrl = "${{ github.event.inputs.trailer_url }}"
        # è·å–è¾“å…¥é“¾æ¥çš„æºä»£ç 
        $sourceCode = curl -s "$trailerUrl"
        
        # æå–åŒ…å« m3u8 çš„å®Œæ•´ HTML ç¡¬ç¼–ç é“¾æ¥
        $m3u8Links = ($sourceCode | Select-String -Pattern 'https.*?\.m3u8.*?"') `
                      -replace '&amp;', '&' `
                      -replace '.*content="(https.*?\.m3u8.*?)".*', '$1'
        
        # é€‰æ‹©ç¬¬ä¸€ä¸ªåŒ¹é…é“¾æ¥
        if ($m3u8Links.Length -gt 0) {
          $processedUrl = $m3u8Links[0]
        } else {
          throw "æœªæ‰¾åˆ°åŒ…å« m3u8 çš„ HTML ç¡¬ç¼–ç é“¾æ¥ï¼"
        }

        # æå– Released æˆ– Coming Soon å…³é”®å­—çš„å€¼
        $releasedRegex = '<dt class="typ-caption">\s*Released\s*</dt>\s*<dd class="product-footer__metadata__section__desc typ-caption clr-secondary-text">\s*(\d{4})\s*</dd>'
        $comingSoonRegex = '<dt class="typ-caption">\s*Coming Soon\s*</dt>\s*<dd class="product-footer__metadata__section__desc typ-caption clr-secondary-text">\s*(\d{4})\s*</dd>'
    
        # å°è¯•åŒ¹é… Released
        $releaseMatch = [regex]::Match($sourceCode, $releasedRegex)
        if ($releaseMatch.Success) {
          $releaseYear = $releaseMatch.Groups[1].Value
          Write-Host "`e[32mExtracted Released year: $releaseYear`e[0m"
        } else {
          # å¦‚æœæœªæ‰¾åˆ° Releasedï¼Œåˆ™åŒ¹é… Coming Soon
          $comingSoonMatch = [regex]::Match($sourceCode, $comingSoonRegex)
          if ($comingSoonMatch.Success) {
            $releaseYear = $comingSoonMatch.Groups[1].Value
            Write-Host "`e[33mReleased year not found. Using Coming Soon year: $releaseYear`e[0m"
          } else {
            Write-Host "`e[33mNo release year or coming soon year found. Defaulting to 'Unknown'.`e[0m"
            $releaseYear = "Unknown"
          }
        }
    
        # å†™å…¥ç¯å¢ƒå˜é‡
        echo "RELEASE_YEAR=$releaseYear" >> $env:GITHUB_ENV
        
        echo "Found m3u8 URL: $processedUrl"
        echo $processedUrl > input.txt
    
    - name: Parse M3U8 with N_m3u8DL-CLI
      if: ${{ github.event.inputs.trailer_url != '' }}
      run: |
        mkdir workdir
        .\N_m3u8DL-CLI.exe $(Get-Content input.txt) --enableParseOnly --workDir workdir
        dir workdir
        $timestamp = Get-ChildItem -Directory workdir | Select-Object -First 1 -ExpandProperty Name
        $rawM3u8File = "workdir\$timestamp\raw.m3u8"
        $masterM3u8File = "workdir\$timestamp\master.m3u8"
        $newM3u8File = "workdir\$timestamp\combined.m3u8"
    
        if (Test-Path $masterM3u8File) {
          echo "# Combined M3U8 file" > $newM3u8File
          Get-Content $masterM3u8File >> $newM3u8File
          echo "" >> $newM3u8File
          Get-Content $rawM3u8File >> $newM3u8File
        } else {
          Copy-Item $rawM3u8File $newM3u8File
        }
        echo "New M3U8 file created at $newM3u8File"
        Get-Content "workdir\$timestamp\combined.m3u8"

    - name: Process combined.m3u8 for Best Stream
      run: |
        # ç¡®å®šç”¨æˆ·è¾“å…¥é€‰æ‹©
        $subtitleLanguage = "${{ github.event.inputs.subtitle_language }}"
        $resolution = "${{ github.event.inputs.resolution }}"
        $audioLanguage = "${{ github.event.inputs.audio_language }}"
        $timestamp = Get-ChildItem -Directory workdir | Select-Object -First 1 -ExpandProperty Name
        $m3u8File = "workdir\$timestamp\combined.m3u8"

        # è¯»å– M3U8 æ–‡ä»¶å†…å®¹
        $m3u8Content = Get-Content $m3u8File -Raw

        # åŒ¹é…ç‰‡å
        $titleRegex = '#EXT-X-SESSION-DATA:DATA-ID="com.apple.hls.title",VALUE="([^"]+?)(?:\s+Trailer)?"'
        $titleMatch = [regex]::Match($m3u8Content, $titleRegex)

        # ä¸­æ–‡å­—ç¬¦æ£€æµ‹æ­£åˆ™è¡¨è¾¾å¼
        $chineseRegex = "[\u4e00-\u9fff]"

        if ($titleMatch.Success -and ($titleMatch.Groups[1].Value -notlike "*Trailer*") -and (-not ($titleMatch.Groups[1].Value -match $chineseRegex))) {
          $movieTitle = $titleMatch.Groups[1].Value
          Write-Host "`e[32mExtracted Movie Title from m3u8: $movieTitle`e[0m"
        } else {
          Write-Host "`e[33mMovie Title contains 'Trailer', Chinese characters, or not found. Falling back to URL extraction...`e[0m"
      
          # è¾“å…¥é“¾æ¥åŒ¹é…é€»è¾‘
          $inputUrl = "${{ github.event.inputs.trailer_url }}"
          if ($inputUrl -match "/movie/([^/]+)/") {
            $movieTitle = $matches[1]
        
            # æ›¿æ¢ç‰‡åä¸­çš„ "-" ç¬¦å·ä¸ºç©ºæ ¼
            $movieTitle = $movieTitle -replace "-", " "
            Write-Host "`e[32mExtracted and processed Movie Title from URL: $movieTitle`e[0m"
          } else {
            Write-Host "`e[33mFailed to extract movie title from URL. Defaulting to 'clip'.`e[0m"
            $movieTitle = "clip"
          }
        }
    
        # å°†æå–çš„ç”µå½±ç‰‡åå†™å…¥ç¯å¢ƒå˜é‡
        echo "MOVIE_TITLE=$movieTitle" >> $env:GITHUB_ENV

        # å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼
        $streamRegex = '#EXT-X-STREAM-INF:(.*?)\n(https?://[^\s]+)'
        $matches = [regex]::Matches($m3u8Content, $streamRegex, 'IgnoreCase, Multiline')

        # åˆ†è¾¨ç‡èŒƒå›´
        if ($resolution -eq '1080p') {
          $minWidth = 1400
          $maxWidth = 2000
        } elseif ($resolution -eq '4K') {
          $minWidth = 3800
          $maxWidth = 4500
        }

        # æŸ¥æ‰¾æœ€ä½³æµ
        $bestStream = $null
        $maxBandwidth = 0
        $finalResolution = $resolution

        foreach ($match in $matches) {
          $streamInf = $match.Groups[1].Value
          $url = $match.Groups[2].Value

          $resolutionMatch = [regex]::Match($streamInf, 'RESOLUTION=(\d+)x(\d+)', 'IgnoreCase')
          $bandwidthMatch = [regex]::Match($streamInf, 'AVERAGE-BANDWIDTH=(\d+)', 'IgnoreCase')

          if ($resolutionMatch.Success -and $bandwidthMatch.Success) {
            $width = [int]$resolutionMatch.Groups[1].Value
            $averageBandwidth = [int]$bandwidthMatch.Groups[1].Value

            if ($width -ge $minWidth -and $width -le $maxWidth) {
              if ($averageBandwidth -gt $maxBandwidth) {
                $maxBandwidth = $averageBandwidth
                $bestStream = $url
              }
            }
          }
        }

        if (-not $bestStream -and $resolution -eq '4K') {
          Write-Host "`e[31mNo 4K stream found, falling back to 1080p.`e[0m"
          $minWidth = 1400
          $maxWidth = 2000
          $maxBandwidth = 0

          foreach ($match in $matches) {
            $streamInf = $match.Groups[1].Value
            $url = $match.Groups[2].Value

            $resolutionMatch = [regex]::Match($streamInf, 'RESOLUTION=(\d+)x(\d+)', 'IgnoreCase')
            $bandwidthMatch = [regex]::Match($streamInf, 'AVERAGE-BANDWIDTH=(\d+)', 'IgnoreCase')

            if ($resolutionMatch.Success -and $bandwidthMatch.Success) {
              $width = [int]$resolutionMatch.Groups[1].Value
              $averageBandwidth = [int]$bandwidthMatch.Groups[1].Value

              if ($width -ge $minWidth -and $width -le $maxWidth) {
                if ($averageBandwidth -gt $maxBandwidth) {
                  $maxBandwidth = $averageBandwidth
                  $bestStream = $url
                  $finalResolution = "1080p"
                }
              }
            }
          }
        }

        if (-not $bestStream) {
          Write-Host "`e[31mNo suitable stream found. Task cancelled.`e[0m"
          exit 1
        }

        Write-Host "`e[32mBest Stream URL: $bestStream`e[0m"
        echo "BEST_STREAM_URL=$bestStream" >> $env:GITHUB_ENV
        echo "FINAL_RESOLUTION=$finalResolution" >> $env:GITHUB_ENV

        # ä¸‹è½½è§†é¢‘å¹¶å†™å…¥ç¯å¢ƒå˜é‡
        .\ffmpeg.exe -i "$bestStream" -c copy "AppleTrailer.mov" *>&1 | Tee-Object -FilePath ffmpeg_download.log -Append
        Write-Host "`e[32mDownloaded video file: AppleTrailer.mov`e[0m"
        echo "VIDEO_FILE=AppleTrailer.mov" >> $env:GITHUB_ENV

        # è°ƒè¯•ï¼šæ‰“å°ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€å€¼
        Write-Host "`e[32mUser Selected Audio Language: $audioLanguage`e[0m"
        # å®šä¹‰éŸ³é¢‘è¯­è¨€æ˜ å°„è¡¨
        $languageMap = @{
          "ğŸ‡ºğŸ‡¸ è‹±è¯­ï¼ˆåŸå£°ï¼‰" = "en"
          "ğŸ‡¨ğŸ‡³ ä¸­æ–‡æ™®é€šè¯" = "cmn"
          "ğŸ‡ªğŸ‡¸ åŠ æ³°ç½—å°¼äºšè¯­" = "ca"
          "ğŸ‡©ğŸ‡ª å¾·è¯­" = "de"
          "ğŸ‡²ğŸ‡½ æ‹‰ä¸ç¾æ´²è¥¿ç­ç‰™è¯­" = "es-419"
          "ğŸ‡ªğŸ‡¸ æ¬§æ´²è¥¿ç­ç‰™è¯­" = "es-ES"
          "ğŸ‡¨ğŸ‡¦ åŠ æ‹¿å¤§æ³•è¯­" = "fr-CA"
          "ğŸ‡«ğŸ‡· æ³•å›½æ³•è¯­" = "fr-FR"
          "ğŸ‡®ğŸ‡¹ æ„å¤§åˆ©è¯­" = "it"
          "ğŸ‡¯ğŸ‡µ æ—¥è¯­" = "ja"
          "ğŸ‡§ğŸ‡· å·´è¥¿è‘¡è„ç‰™è¯­" = "pt-BR"
          "ğŸ‡·ğŸ‡º ä¿„è¯­" = "ru"
          "ğŸ‡¹ğŸ‡­ æ³°è¯­" = "th"
          "ğŸ‡¹ğŸ‡· åœŸè€³å…¶è¯­" = "tr"
          "ğŸ‡ºğŸ‡¦ ä¹Œå…‹å…°è¯­" = "uk"
        }
        
        # ç¡®å®šéŸ³é¢‘è¯­è¨€æ ‡ç­¾
        $languageTag = $languageMap[$audioLanguage]
        # è°ƒè¯•ï¼šæ‰“å°å¤„ç†åçš„è¯­è¨€æ ‡ç­¾å€¼
        Write-Host "`e[32mProcessed Language Tag: $languageTag`e[0m"
        $bestAudioUrl = $null
        if ($finalResolution -eq '1080p') {
          # é»˜è®¤çš„è‹±è¯­æ ‡ç­¾
          $defaultAudioTag = "en"
          # å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼
          $audioRegex = "(https?://[^\s]+_audio_${languageTag}_gr160_.*?\.m3u8)"
          $audioRegexDefault = "(https?://[^\s]+_audio_${defaultAudioTag}_gr160_.*?\.m3u8)"
          $audioRegexOld = "(https?://[^\s]+gr160\.m3u8)"
          $audioA = "(https?://[^\s]+gr160_.*?\.m3u8)"
          $audioB = "(https?://[^\s]+_audio_${languageTag}-DE_gr160_.*?\.m3u8)"
          $audioC = "(https?://[^\s]+_audio_${languageTag}-IT_gr160_.*?\.m3u8)"
          $audioD = "(https?://[^\s]+gr160-.m3u8)"
          # åŒ¹é…æ‰€æœ‰éŸ³é¢‘é“¾æ¥ (ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€)
          $audioMatches = [regex]::Matches($m3u8Content, $audioRegex, 'IgnoreCase')
          # å¦‚æœæœªæ‰¾åˆ°ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€ï¼Œåˆ™å¯»æ‰¾ä¸‹ä¸€ä¸ª
          if ($audioMatches.Count -eq 0) {
            $audioMatches = [regex]::Matches($m3u8Content, $audioB, 'IgnoreCase')
            # å¦‚æœä»æœªæ‰¾åˆ°ï¼Œåˆ™å¯»æ‰¾ä¸‹ä¸€ä¸ª
            if ($audioMatches.Count -eq 0) {
              $audioMatches = [regex]::Matches($m3u8Content, $audioC, 'IgnoreCase')
              if ($audioMatches.Count -eq 0) {
                $audioMatches = [regex]::Matches($m3u8Content, $audioRegexDefault, 'IgnoreCase')
                if ($audioMatches.Count -eq 0) {
                  $audioMatches = [regex]::Matches($m3u8Content, $audioRegexOld, 'IgnoreCase')
                  if ($audioMatches.Count -eq 0) {
                    $audioMatches = [regex]::Matches($m3u8Content, $audioA, 'IgnoreCase')
                    if ($audioMatches.Count -eq 0) {
                      $audioMatches = [regex]::Matches($m3u8Content, $audioD, 'IgnoreCase')
                    }
                  }
                }
              }
            }
          }
          # æå–æœ€ä½³éŸ³é¢‘é“¾æ¥
          if ($audioMatches.Count -gt 0) {
            $bestAudioUrl = $audioMatches[0].Groups[1].Value
          }
          if ($bestAudioUrl) {
            Write-Host "`e[32mFound the best audio URL: $bestAudioUrl`e[0m"
            .\ffmpeg.exe -i $bestAudioUrl -c copy audio.m4a
            echo "AUDIO_FILE=audio.m4a" >> $env:GITHUB_ENV
            # è°ƒè¯•ï¼šæ‰“å°ä¸‹è½½åçš„éŸ³é¢‘æ–‡ä»¶
            Write-Host "`e[32mDownloaded Audio File: audio.m4a`e[0m"
          } else {
            Write-Host "`e[31mNo suitable audio stream found. Task cancelled.`e[0m"
            exit 1
          }
        } elseif ($finalResolution -eq '4K') {
          # é»˜è®¤çš„è‹±è¯­æ ‡ç­¾
          $defaultAudioTag = "en"
          # å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼
          $audioRegex = "(https?://[^\s]+_audio_${languageTag}_gr(\d+)_.*?\.m3u8)"
          $audioRegexDefault = "(https?://[^\s]+_audio_${defaultAudioTag}_gr(\d+)_.*?\.m3u8)"
          # åŒ¹é…æ‰€æœ‰éŸ³é¢‘é“¾æ¥ (ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€)
          $audioMatches = [regex]::Matches($m3u8Content, $audioRegex, 'IgnoreCase')
          # å¦‚æœæœªæ‰¾åˆ°ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€ï¼Œåˆ™å›é€€åˆ°é»˜è®¤çš„è‹±è¯­éŸ³é¢‘
          if ($audioMatches.Count -eq 0) {
            $audioMatches = [regex]::Matches($m3u8Content, $audioRegexDefault, 'IgnoreCase')
          }
          $maxGrValue = 0
          # æ¯”å¯¹græ•°å€¼ï¼Œé€‰æ‹©æœ€å¤§grå€¼çš„éŸ³é¢‘é“¾æ¥
          foreach ($match in $audioMatches) {
            $audioUrl = $match.Groups[1].Value
            $grValue = [int]$match.Groups[2].Value
            if ($grValue -gt $maxGrValue) {
              $maxGrValue = $grValue
              $bestAudioUrl = $audioUrl
            }
          }
          if ($bestAudioUrl) {
            Write-Host "`e[32mFound the best audio URL: $bestAudioUrl`e[0m"
            .\ffmpeg.exe -i $bestAudioUrl -c copy audio.ec3 *>&1 | Tee-Object -FilePath ffmpeg_download.log -Append
            echo "AUDIO_FILE=audio.ec3" >> $env:GITHUB_ENV
            echo "FFMPEG_LOG=ffmpeg_download.log" >> $env:GITHUB_ENV
            # è°ƒè¯•ï¼šæ‰“å°ä¸‹è½½åçš„éŸ³é¢‘æ–‡ä»¶
            Write-Host "`e[32mDownloaded Audio File: audio.ec3`e[0m"
          } else {
            Write-Host "`e[31mNo suitable audio stream found. Task cancelled.`e[0m"
            exit 1
          }
        }
        
        # è°ƒè¯•ï¼šæ‰“å°ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€å€¼
        Write-Host "`e[32mUser Selected Subtitle Language: $subtitleLanguage`e[0m"
        # å®šä¹‰å­—å¹•è¯­è¨€æ˜ å°„è¡¨
        $subtitleLanguageMap = @{
          "ğŸ‡¨ğŸ‡³ ä¸­æ–‡ç®€ä½“" = "cmn-Hans"
          "ğŸ‡¹ğŸ‡¼ ä¸­æ–‡ç¹é«”" = "cmn-Hant"
          "ğŸ‡­ğŸ‡° ä¸­æ–‡ç²¤è¯­" = "yue-Hant"
          "ğŸ‡ºğŸ‡¸ è‹±è¯­ English" = "en"
          "ğŸ‡¸ğŸ‡¦ é˜¿æ‹‰ä¼¯è¯­ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" = "ar"
          "ğŸ‡§ğŸ‡¬ ä¿åŠ åˆ©äºšè¯­ Ğ±ÑŠĞ»Ğ³Ğ°Ñ€ÑĞºĞ¸" = "bg"
          "ğŸ‡¨ğŸ‡¿ æ·å…‹è¯­ ÄŒeÅ¡tina" = "cs"
          "ğŸ‡©ğŸ‡° ä¸¹éº¦è¯­ dansk" = "da"
          "ğŸ‡©ğŸ‡ª å¾·è¯­ Deutsch" = "de"
          "ğŸ‡¬ğŸ‡· å¸Œè…Šè¯­ Î•Î»Î»Î·Î½Î¹ÎºÎ¬" = "el"
          "ğŸ‡²ğŸ‡½ è¥¿ç­ç‰™è¯­ï¼ˆæ‹‰ä¸ç¾æ´²ï¼‰ EspaÃ±ol (LatinoamÃ©rica)" = "es-419"
          "ğŸ‡ªğŸ‡¸ è¥¿ç­ç‰™è¯­ï¼ˆè¥¿ç­ç‰™ï¼‰ EspaÃ±ol (EspaÃ±a)" = "es-ES"
          "ğŸ‡ªğŸ‡ª çˆ±æ²™å°¼äºšè¯­ eesti" = "et"
          "ğŸ‡«ğŸ‡® èŠ¬å…°è¯­ Suomi" = "fi"
          "ğŸ‡¨ğŸ‡¦ æ³•è¯­ï¼ˆåŠ æ‹¿å¤§ï¼‰ FranÃ§ais (Canada)" = "fr-CA"
          "ğŸ‡«ğŸ‡· æ³•è¯­ï¼ˆæ³•å›½ï¼‰ FranÃ§ais (France)" = "fr-FR"
          "ğŸ‡®ğŸ‡± å¸Œä¼¯æ¥è¯­ ×¢×‘×¨×™×ª" = "he"
          "ğŸ‡®ğŸ‡³ å°åœ°è¯­ à¤¹à¤¿à¤¨à¥à¤¦à¥€" = "hi"
          "ğŸ‡­ğŸ‡º åŒˆç‰™åˆ©è¯­ magyar" = "hu"
          "ğŸ‡®ğŸ‡© å°å°¼è¯­ Bahasa Indonesia" = "id"
          "ğŸ‡®ğŸ‡¹ æ„å¤§åˆ©è¯­ Italiano" = "it"
          "ğŸ‡¯ğŸ‡µ æ—¥è¯­ æ—¥æœ¬èª" = "ja"
          "ğŸ‡°ğŸ‡· éŸ©è¯­ í•œêµ­ì–´" = "ko"
          "ğŸ‡±ğŸ‡¹ ç«‹é™¶å®›è¯­ lietuviÅ³" = "lt"
          "ğŸ‡±ğŸ‡» æ‹‰è„±ç»´äºšè¯­ latvieÅ¡u" = "lv"
          "ğŸ‡²ğŸ‡¾ é©¬æ¥è¯­ Bahasa Melayu" = "ms"
          "ğŸ‡³ğŸ‡± è·å…°è¯­ Nederlands" = "nl"
          "ğŸ‡³ğŸ‡´ æŒªå¨è¯­ norsk" = "no"
          "ğŸ‡µğŸ‡± æ³¢å…°è¯­ polski" = "pl"
          "ğŸ‡§ğŸ‡· è‘¡è„ç‰™è¯­ï¼ˆå·´è¥¿ï¼‰ PortuguÃªs (Brasil)" = "pt-BR"
          "ğŸ‡µğŸ‡¹ è‘¡è„ç‰™è¯­ PortuguÃªs" = "pt"
          "ğŸ‡·ğŸ‡º ä¿„è¯­ Ğ ÑƒÑÑĞºĞ¸Ğ¹" = "ru"
          "ğŸ‡¸ğŸ‡° æ–¯æ´›ä¼å…‹è¯­ SlovenÄina" = "sk"
          "ğŸ‡¸ğŸ‡® æ–¯æ´›æ–‡å°¼äºšè¯­ slovenÅ¡Äina" = "sl"
          "ğŸ‡¸ğŸ‡ª ç‘å…¸è¯­ Svenska" = "sv"
          "ğŸ‡®ğŸ‡³ æ³°ç±³å°”è¯­ à®¤à®®à®¿à®´à¯" = "ta"
          "ğŸ‡®ğŸ‡³ æ³°å¢å›ºè¯­ à°¤à±†à°²à±à°—à±" = "te"
          "ğŸ‡¹ğŸ‡­ æ³°è¯­ à¹„à¸—à¸¢" = "th"
          "ğŸ‡¹ğŸ‡· åœŸè€³å…¶è¯­ TÃ¼rkÃ§e" = "tr"
          "ğŸ‡ºğŸ‡¦ ä¹Œå…‹å…°è¯­ ÑƒĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°" = "uk"
          "ğŸ‡»ğŸ‡³ è¶Šå—è¯­ Tiáº¿ng Viá»‡t" = "vi"
        }
          
        
        # ç¡®å®šå­—å¹•è¯­è¨€æ ‡ç­¾
        $subtitleTag = $subtitleLanguageMap[$subtitleLanguage]
        # è°ƒè¯•ï¼šæ‰“å°å¤„ç†åçš„è¯­è¨€æ ‡ç­¾å€¼
        Write-Host "`e[32mProcessed Subtitle Tag: $subtitleTag`e[0m"

        $bestSubtitleUrl = $null

        # å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼
        $subtitleRegex = "(https?://[^\s]+_${subtitleTag}_subtitles_.*?\.m3u8)"

        # åŒ¹é…æ‰€æœ‰å­—å¹•é“¾æ¥ (ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€)
        $subtitleMatches = [regex]::Matches($m3u8Content, $subtitleRegex, 'IgnoreCase')

        # æå–æœ€ä½³å­—å¹•é“¾æ¥
        if ($subtitleMatches.Count -gt 0) {
          $bestSubtitleUrl = $subtitleMatches[0].Groups[1].Value
        }

        if ($bestSubtitleUrl) {
          Write-Host "`e[32mFound the best subtitle URL: $bestSubtitleUrl`e[0m"
          .\ffmpeg.exe -i $bestSubtitleUrl -c copy subtitles.vtt
          .\ffmpeg.exe -i subtitles.vtt subtitles.srt
          Remove-Item subtitles.vtt
          Write-Host "`e[32må­—å¹•ä¸‹è½½å¹¶è½¬æ¢å®Œæˆï¼Œè¾“å‡ºæ–‡ä»¶ï¼šsubtitles.srt`e[0m"
          echo "SUBTITLE_FILE=subtitles.srt" >> $env:GITHUB_ENV
        } else {
          Write-Host "`e[31mNo suitable subtitle stream found. Skipping subtitles.`e[0m"
        }

        # è§†é¢‘ã€éŸ³é¢‘å’Œå­—å¹•æ··æµå°è£…å¹¶å‘½å
        $videoFileName = "$movieTitle-${{ env.RELEASE_YEAR }}-$finalResolution-AppleTrailer" -replace "[:?!*ï¼š]", "-"
        if ($finalResolution -eq "1080p") {
          $audioFile = "audio.m4a"
        } elseif ($finalResolution -eq "4K") {
          $audioFile = "audio.ec3"
        }
          
        if (Test-Path "subtitles.srt") {
          Write-Host "å°è£…è§†é¢‘ã€éŸ³é¢‘å’Œå­—å¹•è‡³ MKV"
          .\ffmpeg.exe -i AppleTrailer.mov -i $audioFile -i subtitles.srt -c copy "${videoFileName}.mkv"
          Write-Host "`e[32mæ··æµå°è£…å®Œæˆï¼Œè¾“å‡ºæ–‡ä»¶ï¼š ${videoFileName}.mkv`e[0m"
          echo "OUTPUT_FILE=${videoFileName}.mkv" >> $env:GITHUB_ENV
        } else {
          Write-Host "å°è£…è§†é¢‘å’ŒéŸ³é¢‘è‡³ MOVï¼ˆæ— å­—å¹•ï¼‰"
          .\ffmpeg.exe -i AppleTrailer.mov -i $audioFile -c copy "${videoFileName}.mov"
          Write-Host "`e[32mæ··æµå°è£…å®Œæˆï¼Œè¾“å‡ºæ–‡ä»¶: ${videoFileName}.mov`e[0m"
          echo "OUTPUT_FILE=${videoFileName}.mov" >> $env:GITHUB_ENV
        }

        # ç¬¬äºŒæ¬¡æ”¹åé€»è¾‘
        $outputFilePath = Get-Item "${videoFileName}.*"
        $outputFileName = $outputFilePath.Name 
        $outputFileExtension = $outputFilePath.Extension

        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ”¹å
        if ($outputFileName -like "*4K*") {
          Write-Host "`e[33mFilename contains '4K'. Checking technical tags...`e[0m"

          # æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦åŒ…å«æŠ€æœ¯æ€§æ ‡ç­¾
          $logContent = Get-Content -Path ffmpeg_download.log -Raw
          $hasDolbyVision = $logContent -match "DOVI configuration"
          $hasDolbyAtmos = $logContent -match "Dolby Atmos"

          if ($hasDolbyVision -and $hasDolbyAtmos) {
            Write-Host "`e[32mBoth 'DolbyVision' and 'DolbyAtmos' tags found. Renaming file...`e[0m"

            # æ„é€ æ–°çš„æ–‡ä»¶å
            $newFileName = "$movieTitle-$finalResolution-AppleTrailer-DolbyVision-DolbyAtmos$outputFileExtension" 
            $newFilePath = Join-Path -Path $outputFilePath.DirectoryName -ChildPath $newFileName

            # é‡å‘½åæ–‡ä»¶
            Rename-Item -Path $outputFilePath.FullName -NewName $newFileName
            Write-Host "`e[32mFile renamed to: $newFileName`e[0m"

            # å†™å…¥ç¯å¢ƒå˜é‡
            echo "RENAMED_FILE=$newFileName" >> $env:GITHUB_ENV
          } else {
            Write-Host "`e[33mTechnical tags not found. Keeping the original filename: $outputFileName`e[0m"
            echo "RENAMED_FILE=$outputFileName" >> $env:GITHUB_ENV
          }
        } else {
          Write-Host "`e[33mFilename does not contain '4K'. No renaming needed.`e[0m"
          echo "RENAMED_FILE=$outputFileName" >> $env:GITHUB_ENV
        }

        # æå–æ”¹ååçš„åç§°ï¼ˆä¸åŒ…æ‹¬æ‰©å±•åï¼‰
        if ($newFileName) {
          $renamedFileBase = [System.IO.Path]::GetFileNameWithoutExtension($newFileName)
        } else {
          # æœªæ”¹åæ—¶ï¼Œä½¿ç”¨åŸå°è£…è¾“å‡ºæ–‡ä»¶åä½œä¸ºåŸºå‡†
          $renamedFileBase = [System.IO.Path]::GetFileNameWithoutExtension($outputFileName)
        }
        Write-Host "`e[32mExtracted base name for renamed file: $renamedFileBase`e[0m"
        echo "RENAMED_FILE_BASE=$renamedFileBase" >> $env:GITHUB_ENV
    
    - name: Upload FFmpeg outputs
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.RENAMED_FILE_BASE }}
        path: |
          ${{ env.RENAMED_FILE }}

    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: m3u8-results
        path: workdir/*
   
